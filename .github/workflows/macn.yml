name: Mac-Remote-Access

on:
  workflow_dispatch:

jobs:
  secure-macos:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Remote Management (VNC/ARD)
        run: |
          # Enable Remote Management and allow access for all users with full privileges
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -restart -agent -menu
          
          # Set a VNC password for legacy clients (optional but recommended for compatibility)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpasswd -vncpasswd "SecureVNC123!"

      - name: Create Admin User
        run: |
          # Generate a random password
          PASSWORD=$(openssl rand -base64 12)
          USERNAME="remoteuser"
          
          # Create the user account via dscl
          sudo dscl . -create /Users/$USERNAME
          sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
          sudo dscl . -create /Users/$USERNAME RealName "Remote Admin"
          sudo dscl . -create /Users/$USERNAME UniqueID 501
          sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
          sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
          sudo dscl . -passwd /Users/$USERNAME "$PASSWORD"
          
          # Grant Admin privileges
          sudo dseditgroup -o edit -a $USERNAME -t user admin
          
          echo "REMOTE_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          # Install via Homebrew
          brew install tailscale
          sudo tailscaled install-system-daemon

      - name: Establish Tailscale Connection
        run: |
          # Authenticate and start Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-mac-${{ github.run_id }}
          
          # Get the Tailscale IP
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection
        run: |
          echo "=== MAC REMOTE ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Protocol: VNC (Port 5900)"
          echo "Username: remoteuser"
          echo "Credentials: $REMOTE_CREDS"
          echo "========================="
          
          # Loop to keep runner alive
          while true; do
            echo "[$(date)] Mac Runner Active..."
            sleep 300
          done
