name: Mac-Remote-Access

on:
  workflow_dispatch:

jobs:
  secure-macos:
    # Uses the latest macOS image (macOS 14 or 15 in late 2025)
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Remote Management (VNC)
        run: |
          # Enable Apple Remote Desktop / VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -restart -agent -menu
          
          # Set a VNC-specific password for legacy client compatibility
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpasswd -vncpasswd "VNCpass123!"

      - name: Create Admin User
        run: |
          USERNAME="remoteuser"
          # Generate a secure random password
          PASSWORD=$(openssl rand -base64 12)
          # UID 501 is taken by the 'runner' user; use 502 to avoid eDSRecordAlreadyExists
          UNIQUE_ID="502"
          
          echo "Setting up user: $USERNAME with UID: $UNIQUE_ID"
          
          # Clean up any existing record
          sudo dscl . -delete /Users/$USERNAME > /dev/null 2>&1 || true
          
          # Create user account
          sudo dscl . -create /Users/$USERNAME
          sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
          sudo dscl . -create /Users/$USERNAME RealName "Remote Admin"
          sudo dscl . -create /Users/$USERNAME UniqueID "$UNIQUE_ID"
          sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
          sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
          sudo dscl . -passwd /Users/$USERNAME "$PASSWORD"
          
          # Grant Administrator privileges
          sudo dseditgroup -o edit -a $USERNAME -t user admin
          
          # Store credentials for the final step
          echo "REMOTE_USER=$USERNAME" >> $GITHUB_ENV
          echo "REMOTE_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install and Start Tailscale
        run: |
          # Install Tailscale via Homebrew
          brew install tailscale
          
          # Start the Tailscale daemon
          sudo tailscaled install-system-daemon
          sleep 5
          
          # Connect to Tailnet
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-mac-${{ github.run_id }}
          
          # Capture Tailscale IP
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection
        run: |
          echo "---------------------------------------------------"
          echo "MAC REMOTE ACCESS ACTIVE"
          echo "---------------------------------------------------"
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username:     $REMOTE_USER"
          echo "Password:     $REMOTE_PASS"
          echo "VNC Password: VNCpass123!"
          echo "---------------------------------------------------"
          echo "To connect from a Mac: Finder -> Cmd+K -> vnc://$TAILSCALE_IP"
          echo "To connect from Windows: Use RealVNC or TigerVNC"
          echo "---------------------------------------------------"
          
          # Infinite loop to keep the runner alive
          while true; do
            echo "[$(date)] Mac Runner Heartbeat - Connection Active"
            sleep 300
          done
