name: Kali Linux with Tailscale
on: workflow_dispatch

jobs:
  kali-rdp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}  # Fixed: changed from auth-key to authkey
          tags: tag:ci

      - name: Setup Kali Desktop and RDP
        run: |
          sudo apt-get update
          # Install Kali desktop environment and RDP server
          sudo apt-get install -y kali-desktop-xfce xrdp
          
          # Configure XRDP to use XFCE
          echo "xfce4-session" > ~/.xsession
          
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Create a user for login
          sudo useradd -m kaliuser
          echo "kaliuser:YourSecurePassword123" | sudo chpasswd
          sudo usermod -aG sudo kaliuser

      - name: Keep Runner Alive
        if: always()  # Ensures the runner stays alive even if previous steps take time
        run: |
          echo "Connect to this IP using Microsoft Remote Desktop:"
          tailscale ip -4
          # Keeps the job running for 6 hours
          sleep 21600 
