name: Ubuntu Desktop with Tailscale
on: workflow_dispatch

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          tags: tag:ci

      - name: Setup Desktop and RDP
        run: |
          sudo apt-get update
          # Install XFCE Desktop (Lightweight) and XRDP
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xrdp
          
          # Configure XRDP to use XFCE session
          echo "xfce4-session" > ~/.xsession
          
          # Start and enable RDP service
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          
          # Create a user for RDP login
          sudo useradd -m ubuntuuser
          echo "ubuntuuser:YourSecurePassword123" | sudo chpasswd
          sudo usermod -aG sudo ubuntuuser
          
          # Fix ownership for the session file
          sudo chown ubuntuuser:ubuntuuser /home/ubuntuuser/.xsession

      - name: Keep Runner Alive
        if: always()
        run: |
          echo "=========================================="
          echo "UBUNTU DESKTOP IS READY (2025)"
          echo "Connect to this IP using Microsoft Remote Desktop:"
          tailscale ip -4
          echo "Username: ubuntuuser"
          echo "Password: YourSecurePassword123"
          echo "=========================================="
          # Keeps the job running for 6 hours
          sleep 21600 
