name: Mac-Remote-Access-Final

on:
  workflow_dispatch:

jobs:
  secure-macos:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Create Admin User and Permissions
        run: |
          USERNAME="remoteuser"
          PASSWORD=$(openssl rand -base64 12)
          # Use 502 to avoid collision with default 'runner' (501)
          UNIQUE_ID="502"
          
          # 1. Create the user account
          sudo dscl . -delete /Users/$USERNAME > /dev/null 2>&1 || true
          sudo dscl . -create /Users/$USERNAME
          sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
          sudo dscl . -create /Users/$USERNAME RealName "Remote Admin"
          sudo dscl . -create /Users/$USERNAME UniqueID "$UNIQUE_ID"
          sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
          sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
          sudo dscl . -passwd /Users/$USERNAME "$PASSWORD"
          sudo dseditgroup -o edit -a $USERNAME -t user admin
          
          # 2. Enable Remote Management (ARD/VNC)
          # This command activates the agent and gives access to ALL users
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -restart -agent -menu
          
          # 3. FIX: Specifically grant 'remoteuser' full privileges (Observer, Control, etc.)
          # This prevents the "Authentication Error" on Android clients
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -access -on -users $USERNAME -privs -all -restart
          
          # 4. Set legacy VNC Password for 3rd-party Android apps
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpasswd -vncpasswd "VNCpass123!"
          
          echo "REMOTE_USER=$USERNAME" >> $GITHUB_ENV
          echo "REMOTE_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install and Start Tailscale
        run: |
          brew install tailscale
          sudo tailscaled install-system-daemon
          sleep 5
          # Join your Tailnet (Requires TAILSCALE_AUTH_KEY in Secrets)
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-mac-${{ github.run_id }}
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection
        run: |
          echo "---------------------------------------------------"
          echo "MAC REMOTE ACCESS READY"
          echo "---------------------------------------------------"
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username:     $REMOTE_USER"
          echo "Password:     $REMOTE_PASS"
          echo "VNC Password: VNCpass123!"
          echo "---------------------------------------------------"
          echo "Android Guide:"
          echo "1. Connect Tailscale on your phone."
          echo "2. Use RealVNC Viewer for Android."
          echo "3. Password 1 (if asked immediately): VNCpass123!"
          echo "4. Password 2 (at Mac Login Screen): $REMOTE_PASS"
          echo "---------------------------------------------------"
          
          while true; do
            echo "[$(date)] Connection Active - Heartbeat Sent"
            sleep 300
          done
