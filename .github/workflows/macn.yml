name: Mac-Remote-Access-Final-2025

on:
  workflow_dispatch:

jobs:
  macos-setup:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Create Admin User
        run: |
          USERNAME="remoteuser"
          PASSWORD=$(openssl rand -base64 12)
          # UID 501 is the default 'runner'; using 502 prevents eDSRecordAlreadyExists
          UNIQUE_ID="502" 
          
          echo "Setting up $USERNAME with UID $UNIQUE_ID..."
          
          # Clean and Create User
          sudo dscl . -delete /Users/$USERNAME > /dev/null 2>&1 || true
          sudo dscl . -create /Users/$USERNAME
          sudo dscl . -create /Users/$USERNAME UserShell /bin/bash
          sudo dscl . -create /Users/$USERNAME RealName "Remote Admin"
          sudo dscl . -create /Users/$USERNAME UniqueID "$UNIQUE_ID"
          sudo dscl . -create /Users/$USERNAME PrimaryGroupID 20
          sudo dscl . -create /Users/$USERNAME NFSHomeDirectory /Users/$USERNAME
          sudo dscl . -passwd /Users/$USERNAME "$PASSWORD"
          sudo dseditgroup -o edit -a $USERNAME -t user admin
          
          echo "REMOTE_USER=$USERNAME" >> $GITHUB_ENV
          echo "REMOTE_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Fix Black Screen and Enable VNC
        run: |
          # 1. Reset Screen Capture permissions for 2025 compatibility
          sudo tccutil reset ScreenCapture || true
          
          # 2. Activate Remote Management service
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate
          
          # 3. Grant ALL users full access privileges (Fixes Authentication Error)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers -privs -all
          
          # 4. Set legacy VNC Password for 3rd-party clients like RealVNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpasswd -vncpasswd "VNCpass123!"
          
          # 5. Restart agent to apply changes
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          # 6. Kill loginwindow to force UI refresh (Fixes Black Screen)
          sudo killall loginwindow

      - name: Install and Start Tailscale
        run: |
          # Use Brew to install Tailscale on macOS 15
          brew install tailscale
          sudo tailscaled install-system-daemon
          sleep 5
          
          # Join your Tailnet
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-mac-${{ github.run_id }}
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection Info
        run: |
          echo "---------------------------------------------------"
          echo "MAC REMOTE ACCESS READY"
          echo "---------------------------------------------------"
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username:     $REMOTE_USER"
          echo "Password:     $REMOTE_PASS"
          echo "VNC Password: VNCpass123!"
          echo "---------------------------------------------------"
          echo "Quick Guide:"
          echo "1. First Prompt (VNC password): VNCpass123!"
          echo "2. Second Prompt (Login Screen): $REMOTE_PASS"
          echo "---------------------------------------------------"
          
          # Keep the runner active for the full duration
          while true; do
            echo "[$(date)] Mac Runner Heartbeat - Connection Active"
            sleep 300
          done
